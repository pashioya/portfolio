name: Deploy

"on":
    workflow_dispatch: {}
    push:
        branches:
            - main

concurrency:
    group: deploy-${{ github.ref }}
    cancel-in-progress: true

jobs:
    deploy:
        name: Deploy to server
        runs-on: ubuntu-latest
        steps:
            - name: Install cloudflared
              run: |
                  set -euo pipefail
                  mkdir -p "$HOME/.local/bin"
                  curl -fsSL "https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64" -o "$HOME/.local/bin/cloudflared"
                  chmod +x "$HOME/.local/bin/cloudflared"
                  echo "$HOME/.local/bin" >> "$GITHUB_PATH"
                  cloudflared --version

            - name: Deploy (Cloudflare Access SSH + git pull)
              env:
                  CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
                  CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_CLIENT_SECRET }}
                  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
                  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
                  DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
                  DEPLOY_SSH_KEY: ${{ secrets.DEPLOY_SSH_KEY }}
              run: |
                  set -euo pipefail

                  if [ -z "${DEPLOY_HOST:-}" ] || [ -z "${DEPLOY_USER:-}" ] || [ -z "${DEPLOY_PATH:-}" ] || [ -z "${DEPLOY_SSH_KEY:-}" ] || [ -z "${CF_ACCESS_CLIENT_ID:-}" ] || [ -z "${CF_ACCESS_CLIENT_SECRET:-}" ]; then
                    echo "Missing required secrets: DEPLOY_HOST, DEPLOY_USER, DEPLOY_PATH, DEPLOY_SSH_KEY, CF_ACCESS_CLIENT_ID, CF_ACCESS_CLIENT_SECRET"
                    exit 1
                  fi

                  mkdir -p ~/.ssh
                  chmod 700 ~/.ssh

                  echo "$DEPLOY_SSH_KEY" > ~/.ssh/id_ed25519
                  chmod 600 ~/.ssh/id_ed25519

                                    ssh -vvv -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=accept-new \
                                        -o ProxyCommand="cloudflared access ssh --hostname %h --service-token-id ${CF_ACCESS_CLIENT_ID} --service-token-secret ${CF_ACCESS_CLIENT_SECRET} --loglevel=debug" \
                        "$DEPLOY_USER@$DEPLOY_HOST" \
                        "set -euo pipefail; \
                        cd '$DEPLOY_PATH'; \
                        git fetch --prune; \
                        git checkout main; \
                        git pull --rebase --ff-only; \
                        pnpm install; \
                        pnpm run build; \
                        sudo -n /usr/bin/systemctl restart portfolio"
